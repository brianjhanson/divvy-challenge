function redraw(){svg.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")").selectAll("path").style({"stroke-width":1/d3.event.scale})}var barPadding=1,rows,maxCap,minCap,maxDuration,minDuration,capScale,currentDate,dateArray=[],win=window,doc=document,docEl=doc.documentElement,body=doc.getElementsByTagName("body")[0],w=win.innerWidth||docEl.clientWidth||body.clientWidth,h=win.innerHeight||docEl.clientHeight||body.clientHeight,dataPath="assets/data/trips_med.csv",dataNeighborhoods="assets/data/neighborhoods.json",dataDivvyStations="assets/data/stations.csv",speed=500,projection=d3.geo.albers().scale(2e5).center([0,41.84562]).rotate([87.65533,0]).translate([h/2,w/2]),path=d3.geo.path().projection(projection),svg=d3.select("#results").append("svg").attr("width",w).attr("height",h).call(d3.behavior.zoom().on("zoom",redraw)).append("g"),setScale=function(t){return maxCap=d3.max(t,function(t){return t.cap}),minCap=d3.min(t,function(t){return t.cap}),capScale=d3.scale.linear().domain([minCap,maxCap]).range([0,10])},setDurationScale=function(t){maxDuration=d3.max(t,function(t){return t.tripDuration}),minDuration=d3.min(t,function(t){return t.tripDuration}),durationScale=d3.scale.linear().domain([minDuration,maxDuration]).range([0,100])},parseNeighborhoods=function(){d3.json(dataNeighborhoods,function(t,e){drawNeighborhoods(e),parseStations()})},drawNeighborhoods=function(t){svg.selectAll("path").data(t.features).enter().append("path").attr("d",path).style({fill:"#444a4a",stroke:"#242626","stroke-width":1})},drawStations=function(t){svg.selectAll("circle").data(t).enter().append("circle").attr("cx",function(t){return projection([t.lon,t.lat])[0]}).attr("cy",function(t){return projection([t.lon,t.lat])[1]}).attr("r",function(t){return capScale(t.cap)}).style("fill","#3db7e4").style("opacity",.75)},parseStations=function(){d3.csv(dataDivvyStations,function(t){return{name:t.name,lat:+t.latitude,lon:+t.longitude,cap:+t.dpcapacity}},function(t,e){setScale(e),drawStations(e)})},cleanDates=function(t){var e=["Sun.","Mon.","Tue.","Wed.","Thu.","Fri.","Sat."],a=["Jan.","Feb.","Mar.","Apr.","May","Jun.","Jul.","Aug.","Sep.","Oct.","Nov.","Dec."],n="AM",r=t.getHours(),i=t.getMinutes();return 12==r?n="PM":r>12&&(r-=12,n="PM"),10>i&&(i="0"+t.getMinutes()),{date:a[t.getMonth()]+" "+t.getDate()+" "+t.getFullYear(),day:e[t.getDay()],hour:r+":"+i+" "+n}},parseTrips=function(){d3.csv(dataPath,function(t){var e=new Date(t.starttime),a=new Date(t.stoptime),n=cleanDates(e),r=cleanDates(a);return{tripID:+t.trip_id,tripStartRaw:new Date(t.starttime),tripStartDate:n.date,tripStartDay:n.day,tripStartTime:n.hour,tripStopRaw:new Date(t.stoptime),tripStopDate:r.date,tripStopDay:r.day,tripStopTime:r.hour,tripDuration:+t.tripduration.replace(/[^\d\.\-\ ]/g,""),bikeID:+t.bikeid,stationFromID:+t.from_station_id,stationFromName:t.from_station_name,stationToID:+t.to_station_id,stationToName:t.to_station_name,userType:t.usertype,userGender:t.gender,userBirthYear:new Date(t.birthyear)}},function(t,e){logData(e),setDurationScale(e),outputTrips(e)})},outputTrips=function(t){var e=d3.select("#trips"),a=e.selectAll("li").data(t).enter().append("li").attr("class","trip-list__trip trip"),n=a.append("div").attr("class","trip__start"),r=a.append("div").attr("class","trip__end");a.style({"background-position":"100%"}).transition().duration(function(t){return 10*t.tripDuration}).delay(function(t){return dataStart=new Date("6/27/2013 12:11").getTime(),delay=t.tripStartRaw.getTime()-dataStart,delay/1e3}).style({"background-position":"0%"}),n.append("div").attr("class","trip__start-time").append("text").text(function(t){return t.tripStartDay+" "+t.tripStartDate+" "+t.tripStartTime}),n.append("div").attr("class","trip__start-station").append("text").text(function(t){return t.stationFromName}),r.append("div").attr("class","trip__end-time").append("text").text(function(t){return t.tripStopDay+" "+t.tripStopDate+" "+t.tripStopTime}),r.append("div").attr("class","trip__end-station").append("text").text(function(t){return t.stationToName})},logData=function(t){t.forEach(function(t){console.log(t)})},chartBars=function(t){svg.selectAll("rect").data(t).enter().append("rect").attr("x",function(e,a){return a*(w/t.length)}).attr("y",function(t){return h-t.tripDuration/100}).attr("width",w/t.length-barPadding).attr("height",function(t){return t.tripDuration/100})},startClock=function(){function t(){e(),setInterval(function(){e(),a(currentDate)},speed)}function e(){return currentDate=new Date(r),r+=i,dateArray=[currentDate,r]}function a(t){cleanedDate=cleanDates(t),prettyDate=cleanedDate.day+" "+cleanedDate.date+" "+cleanedDate.hour,document.getElementById("clock").innerHTML=prettyDate}var n=new Date("Thu Jun 27 2013 12:11:00 GMT-0500 (CDT)"),r=n.getTime(),i=6e4;t()};parseTrips(),parseNeighborhoods(),startClock(),function(){for(var t,e=function(){},a=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],n=a.length,r=window.console=window.console||{};n--;)t=a[n],r[t]||(r[t]=e)}();